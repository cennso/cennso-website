 # Analytics drain is realtime and stores data under "analytics/raw/YYYY/MM/" prefix as ndjson shards.
 # This workflow calls the /api/wa-drain-monthly endpoint to aggregate all shards for a given month
 # into a single gzipped ndjson file stored under "analytics/monthly/YYYY-MM.ndjson.gz".

name: Monthly Analytics Dump
on:
  schedule:
    - cron: "0 2 1 * *"   # 02:00 UTC on the 1st of each month
  workflow_dispatch:
    inputs:
      month:
        description: 'Target month in YYYY-MM format (e.g., 2023-10). Leave empty for previous month.'
        required: false
        type: string

jobs:
  dump:
    runs-on: ubuntu-latest
    steps:
      - name: Run monthly dump
        run: |
          curl -X POST "https://cennso.com/api/wa-drain-monthly?month=${{ github.event.inputs.month }}&token=${{ secrets.DRAIN_TOKEN }}"
