concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
name: Lighthouse Performance Check
on:
  pull_request_target:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
jobs:
  # Wait for Vercel deployment once, share URL with audit jobs
  wait-for-deployment:
    name: Wait for Vercel deployment
    permissions:
      contents: read
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.vercel-deployment.outputs.url }}
    steps:
      - name: Wait for Vercel deployment
        uses: patrickedqvist/wait-for-vercel-preview@06c79330064b0e6ef7a2574603b62d3c98789125 #1.3.2 release
        id: vercel-deployment
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          max_timeout: 300

  # Run desktop and mobile audits in parallel
  lighthouse-audit:
    name: Lighthouse audit (${{ matrix.device }})
    needs: wait-for-deployment
    permissions:
      contents: read
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue mobile audit even if desktop fails
      matrix:
        device: [desktop, mobile]
        include:
          - device: desktop
            config: .lighthouserc.ci.js
            output-dir: lighthouse-desktop
            output-json: lighthouse-results.json
            output-html: lighthouse-desktop.html
          - device: mobile
            config: lighthouse.mobile.config.ci.js
            output-dir: lighthouse-mobile
            output-json: lighthouse-mobile-results.json
            output-html: lighthouse-mobile.html
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}  # pull_request_target defaults to base branch, so explicitly checkout PR code
      - name: Set up NodeJS
        uses: actions/setup-node@v4
      - name: Install Yarn
        run: |-
          npm install -g yarn
          yarn -v
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Replace localhost URLs with Vercel deployment URL
        run: |
          DEPLOY_URL="${{ needs.wait-for-deployment.outputs.url }}"
          echo "Testing against deployment: $DEPLOY_URL"
          
          # Replace localhost URLs in shared Lighthouse URLs file
          # This file is imported by both desktop and mobile base configs
          sed -i "s|http://localhost:3000|$DEPLOY_URL|g" lighthouse.urls.js
      - name: Run Lighthouse audit (${{ matrix.device }})
        env:
          LIGHTHOUSE_URL: ${{ needs.wait-for-deployment.outputs.url }}
        run: |
          set -euo pipefail
          
          # Uses matrix config (desktop or mobile)
          lhci collect --config=${{ matrix.config }}
          lhci upload --config=${{ matrix.config }} --target=filesystem --outputDir=./${{ matrix.output-dir }}
          node scripts/process-lhci-results.js \
            --manifestDir=${{ matrix.output-dir }} \
            --outputJson=${{ matrix.output-json }} \
            --outputHtml=${{ matrix.output-html }} \
            --targetUrl=${LIGHTHOUSE_URL}
          lhci assert --config=${{ matrix.config }}
          
          # Verify artifacts exist
          if [ ! -f ./${{ matrix.output-json }} ] || [ ! -f ./${{ matrix.output-html }} ]; then
            echo "Error: ${{ matrix.device }} Lighthouse artifacts missing."
            exit 1
          fi
      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results-${{ matrix.device }}
          path: |
            ${{ matrix.output-json }}
            ${{ matrix.output-html }}

  # Post comment after both audits complete
  post-comment:
    name: Post Lighthouse comment
    needs: [wait-for-deployment, lighthouse-audit]
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download desktop results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-results-desktop
      - name: Download mobile results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-results-mobile
      - name: Post Lighthouse comment
        uses: actions/github-script@v7
        env:
          DEPLOY_URL: ${{ needs.wait-for-deployment.outputs.url }}
          RUN_ID: ${{ github.run_id }}
        with:
          script: |
            const fs = require('fs').promises;
            
            const desktopResults = JSON.parse(await fs.readFile('lighthouse-results.json', 'utf8'));
            const mobileResults = JSON.parse(await fs.readFile('lighthouse-mobile-results.json', 'utf8'));
            const deployUrl = process.env.DEPLOY_URL;
            const runId = process.env.RUN_ID;
            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            
            let comment = '## ğŸ” Lighthouse Audit Results\n\n';
            comment += `ğŸŒ **Tested deployment**: [${deployUrl}](${deployUrl})\n\n`;
            
            // Desktop scores
            comment += '### ğŸ–¥ï¸ Desktop\n\n';
            comment += '| Category | Score | Status |\n';
            comment += '|----------|-------|--------|\n';
            
            let allPassed = true;
            for (const [key, value] of Object.entries(desktopResults.categories)) {
              if (key === 'pwa') continue;
              const score = Math.round(value.score * 100);
              const status = score >= 95 ? 'âœ… PASS' : 'âŒ FAIL';
              if (score < 95) allPassed = false;
              comment += `| ${value.title} | ${score} | ${status} |\n`;
            }
            
            // Mobile scores
            comment += '\n### ğŸ“± Mobile\n\n';
            comment += '| Category | Score | Status |\n';
            comment += '|----------|-------|--------|\n';
            
            for (const [key, value] of Object.entries(mobileResults.categories)) {
              if (key === 'pwa') continue;
              const score = Math.round(value.score * 100);
              const status = score >= 95 ? 'âœ… PASS' : 'âŒ FAIL';
              if (score < 95) allPassed = false;
              comment += `| ${value.title} | ${score} | ${status} |\n`;
            }
            
            comment += '\n';
            if (allPassed) {
              comment += 'âœ… **All scores are â‰¥95%** - Quality gate passed!';
            } else {
              comment += 'âŒ **Some scores below 95%** - Please improve Lighthouse scores to â‰¥95% on all categories (Performance, Accessibility, Best Practices, SEO).\n\n';
              comment += 'ğŸ’¡ **Download the full HTML reports below** for detailed recommendations on what to fix.';
            }
            
            comment += '\n\n---\n\n';
            comment += '### ğŸ“Š Detailed Reports\n\n';
            comment += `ğŸ“¥ **[Download Full Reports (HTML)](${artifactUrl})**\n\n`;
            comment += 'The workflow run contains detailed HTML reports:\n';
            comment += '- `lighthouse-results-desktop` artifact - Desktop audit report\n';
            comment += '- `lighthouse-results-mobile` artifact - Mobile audit report\n\n';
            comment += '> ğŸ’¡ Click the link above, scroll to "Artifacts" section at the bottom, and download the reports';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
